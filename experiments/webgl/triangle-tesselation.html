<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>juulio.com - Julio Del Valle - Costa Rica</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="HandheldFriendly" content="true">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="/css/styles.css">

  <style>
      .clear {
      	clear: both;
      }

      h1 {
      	font-size: 200%;
      	margin-top: 25px;
      	text-align: center;
      }

      h2 {
      	font-size: 170%;
      	margin-bottom: 25px;
      }

      .main_container {
      	width: 900px;
      	margin: 20px auto 0;
      }

      .canvas_container {
      	float: left;
      	width: 400px;
      }

      .controls_container {
      	float: left;
      	width: 430px;
      	padding-top: 70px;
      	padding-left: 70px;
      }

      p {
      	margin-bottom: 40px;
      }
  </style>
</head>

<body>
	<nav>
		<a href="/" class="home-link">juulio.com</a>
	</nav>

  <script id="vertex-shader" type="x-shader/x-vertex">
  attribute vec4 vPosition;

  void
  main()
  {
      gl_Position = vPosition;
  }
  </script>

  <script id="fragment-shader" type="x-shader/x-fragment">
  precision mediump float;

  void
  main()
  {
      gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
  }
  </script>

  <script type="text/javascript" src="Common/webgl-utils.js"></script>
  <script type="text/javascript" src="Common/initShaders.js"></script>
  <script type="text/javascript" src="Common/MV.js"></script>


  <h1>Tessellation + Twist</h1>
  <div class="main_container">
      <div class="canvas_container">
          <canvas id="gl-canvas" width="400" height="400">
          Oops ... your browser doesn't support the HTML5 canvas element
          </canvas>
      </div>
      <div class="controls_container">
          <h2>Controls Panel</h2>
          <p>Number of recursive steps: <span id="recursiveSteps">0</span><br>
          0 <input id="steps_slider" type="range" min="0" max="5" step="1" value="0"> 5</p>
          <p>Twist angle: <span id="twistAngle"></span><br>
          0 <input id="angle_slider" type="range" min="0" max="360" step="1" value="0"> 360</p>
          </p>
          <p><label for="toggleAnimation"><input id="toggleAnimation" type="checkbox" checked>Toggle Animation</label></p>
      </div>
      <div class="clear"></div>
  </div>

  <script type="text/javascript">
  // x' = xcosA - ysinA
  // y' = xsinA + ycosA

  'use strict';

  var canvas,
      gl,
      bufferId,
      points = [],
      twistAngle = 0, // 8 degrees
      NumTimesToSubdivide = 0,
      animate = true;


  function init() {
      canvas = document.getElementById( "gl-canvas" );

      gl = WebGLUtils.setupWebGL( canvas );
      if ( !gl ) { alert( "WebGL isn't available" ); }

      //  Configure WebGL

      gl.viewport( 0, 0, canvas.width, canvas.height );
      gl.clearColor( 1.0, 1.0, 1.0, 1.0 );

      //  Load shaders and initialize attribute buffers

      var program = initShaders( gl, "vertex-shader", "fragment-shader" );
      gl.useProgram( program );

      // Load the data into the GPU

      bufferId = gl.createBuffer();
      gl.bindBuffer( gl.ARRAY_BUFFER, bufferId );
      gl.bufferData( gl.ARRAY_BUFFER, 8*Math.pow(3, 6), gl.STATIC_DRAW );

      // Associate out shader variables with our data buffer

      var vPosition = gl.getAttribLocation( program, "vPosition" );
      gl.vertexAttribPointer( vPosition, 2, gl.FLOAT, false, 0, 0 );
      gl.enableVertexAttribArray( vPosition );


      // Tessellation / recursive steps slider handler
      document.getElementById("steps_slider").onchange = function(target) {
          NumTimesToSubdivide = parseInt(event.target.value);
          render();
          document.getElementById("recursiveSteps").innerHTML = NumTimesToSubdivide;
      }


      // Twist angle slider handler
      document.getElementById("angle_slider").onchange = function(target) {
          twistAngle = parseInt(event.target.value);
          render();
          document.getElementById("twistAngle").innerHTML = twistAngle;
      }


      // Continuous animation checkbox handler
      document.getElementById("toggleAnimation").onclick = function(target) {
          animate = toggleAnimation.checked;
      }

      // toggle continuous animation

      setInterval(function () {
          if (animate) {
              if(NumTimesToSubdivide < 5) {
                  NumTimesToSubdivide++;
              }
              else {
                  NumTimesToSubdivide = 0;
              }
              document.getElementById("recursiveSteps").innerHTML = NumTimesToSubdivide;
              document.getElementById("steps_slider").value = NumTimesToSubdivide;
              render();
          }
      }, 1000);

      render();
  }

  function triangle(a,b,c) {
      points.push(a,b,c);
  }

  function divideTriangle(a,b,c,count) {
      if(count===0) {
          triangle(twist(a), twist(b), twist(c));
          //triangle(a,b,c);
      }
      else {
          // bisect the sides
          var ab = mix(a,b,0.5),
              ac = mix(a,c,0.5),
              bc = mix(b,c,0.5);
          --count;

          // three new triangles
          divideTriangle(a,ab,ac,count);
          divideTriangle(b,ab,bc,count);
          divideTriangle(c,ac,bc,count);
      }
  }

  window.onload = init;

  function render() {
      var vertices  = [
          vec2(-0.8, -0.5),
          vec2(0, 0.8),
          vec2(0.8, -0.5)
      ];

      points = [];

      divideTriangle(vertices[0],vertices[1],vertices[2],NumTimesToSubdivide);
      gl.bufferSubData(gl.ARRAY_BUFFER, 0, flatten(points));
      gl.clear( gl.COLOR_BUFFER_BIT );
      gl.drawArrays( gl.TRIANGLES, 0, points.length );
      points = [];

  }

  function twist(point){
      //console.log(point);
      var x = point[0],
          y = point[1],
          d = Math.sqrt( (Math.pow(x,2) + Math.pow(y,2)) ),
          alpha = d*(twistAngle* Math.PI / 180),
          xPrime = x*Math.cos(alpha)-y*Math.sin(alpha),
          yPrime = x*Math.sin(alpha)+y*Math.cos(alpha);

      return vec2(xPrime, yPrime);
  }

  </script>

</body>

</html>
